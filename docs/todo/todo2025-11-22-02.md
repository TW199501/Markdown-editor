# TODO 2025-11-22 02

## 主題：規劃 @gravity-ui/markdown-editor 的 UI flow 文件（ui-flow-\<feature\>.md 系列）

本檔用來專門規劃「UI 相關文件」的結構，目標是在不讓 docs 檔案爆炸的前提下，為少數關鍵 UI 功能撰寫 `ui-flow-\<feature\>.md`，搭配 `PROJECT_OVERVIEW.md` 與 `FRONTEND_ARCH.md` 一起使用。

### [問題標題]

- 如何為這個以 UI 為主打的 Markdown editor 設計一組 **少量但高價值** 的 `ui-flow-\<feature\>.md` 文件，幫助之後：
  - 理解整體 UI 行為（模式切換、toolbar、preview/split 等）。
  - 在客製化或除錯 UI 時，有清楚的流程圖與檔案索引可參考。

### [背景與重現步驟]

- 專案定位：
  - `@gravity-ui/markdown-editor` 是以 UI 體驗為核心的 React Markdown 編輯器。
  - 目前已經有：
    - `docs/PROJECT_OVERVIEW.md`：專案總覽。
    - `docs/FRONTEND_ARCH.md`：前端架構與啟動流程說明。
- 需求背景：
  - 想更聚焦在「UI 行為與使用者路徑」本身，而不是只看程式碼結構。
  - 希望為之後的 bugfix / 功能調整（特別是 UI/UX 向）提供視覺化流程與關鍵檔案列表。
- 目前狀態：
  - 尚未建立任何 `docs/ui-flow-*.md`。
  - 僅有高層級的架構說明，缺少針對單一 UI 功能的 flow 文件。

### [相關檔案路徑與定位]

- 文件：
  - `docs/PROJECT_OVERVIEW.md`：
    - 提供專案目標、技術棧與目錄結構高層視圖。
  - `docs/FRONTEND_ARCH.md`：
    - 說明從 React 應用 / Storybook → `useMarkdownEditor` → `MarkdownEditorView` → core/markup/extensions 的啟動流程與分層。
  -（預計新增）`docs/ui-flow-editor-shell.md`、`docs/ui-flow-toolbar.md`、`docs/ui-flow-preview-split.md` 等。
- UI 相關程式碼（之後做 flow 時會用到）：
  - `src/bundle/MarkdownEditorView.tsx`：
    - Editor UI 外殼：模式切換、preview/split、settings、ErrorBoundary 等。
  - `src/bundle/HorizontalDrag.tsx`、`src/bundle/SplitModeView.tsx`：
    - split mode UI 與拖拉調整。
  - `src/bundle/toolbar/utils/toolbarsConfigs.ts`、`src/modules/toolbars/*`、`src/toolbar/*`：
    - 工具列 preset 與 toolbar 組態邏輯。
  - `src/styles/styles.scss`、`src/bundle/MarkdownEditorView.scss`：
    - UI 外觀、BEM class 命名。
  - `demo/stories/**`：
    - 各類 UI 場景（如 mobile、GPT、table 拖拉、CSS variables 等）的實作例子。

### [分析與方案]

1. UI flow 文件的角色與層級
   - `PROJECT_OVERVIEW.md`：
     - 給「剛進專案的人」看整體輪廓。
   - `FRONTEND_ARCH.md`：
     - 給「要動前端或整合 editor」的人看啟動流程與模組分層。
   - `ui-flow-<feature>.md`（本檔要規劃的）：
     - 給「要深入改某個 UI 功能」的人看：
       - 使用者操作流程（畫面 → 操作 → 結果）。
       - 資料／狀態流向（editor 狀態、props、events）。
       - 關鍵檔案與函式列表。

2. 預計規劃的 UI feature 清單（初版）
   - **(1) editor-shell**（建議檔名：`docs/ui-flow-editor-shell.md`）
     - 範圍：整個編輯器殼、模式切換（wysiwyg/markup/split/preview）、設定區塊 `EditorSettings`、ErrorBoundary。
     - 主要檔案：
       - `src/bundle/MarkdownEditorView.tsx`
       - `src/bundle/HorizontalDrag.tsx`
       - `src/bundle/SplitModeView.tsx`
   - **(2) toolbar**（建議檔名：`docs/ui-flow-toolbar.md`）
     - 範圍：工具列 preset、toolbarConfig / hiddenActionsConfig、sticky toolbar。
     - 主要檔案：
       - `src/bundle/toolbar/utils/toolbarsConfigs.ts`
       - `src/modules/toolbars/*`
       - `src/toolbar/*`
   - **(3) preview/split**（建議檔名：`docs/ui-flow-preview-split.md`）
     - 範圍：markup 模式下的 preview 與 split mode 行為，以及對應快捷鍵（Ctrl/Cmd+Shift+P、Ctrl/Cmd+Enter）。
     - 主要檔案：
       - `src/bundle/MarkdownEditorView.tsx`
       - `src/bundle/HorizontalDrag.tsx`
       - `src/bundle/SplitModeView.tsx`
   - **(4) settings 面板**（建議檔名：`docs/ui-flow-settings-panel.md`）
     - 範圍：`EditorSettings` 如何控制模式、preview、toolbar visibility 與 split mode。
   - **(5) GPT / 擴充面板**（之後再視需求開）
     - 範圍：GPT extension 或其他複雜 extension 所使用的 UI。
     - 資料來源主要在 `demo/stories/gpt/*` 與相應 extensions。

3. 每一份 `ui-flow-<feature>.md` 預期格式
   - 固定結構（草案）：
     - `[Feature 名稱與範圍說明]`
     - `## 1. 使用者操作流程（Mermaid flowchart）`
       - 描述從「進入畫面 → 操作 → 畫面變化」的流程。
     - `## 2. 資料 / 狀態流向`
       - editor 狀態、props、events 如何在這個 feature 中流動。
     - `## 3. 關聯檔案與關鍵節點`
       - 列出程式檔案與主要函式 / 元件名稱。
     - `## 4. 延伸與 TODO`
       - 記錄未來想改善或待釐清的點（連回每日 todo）。

4. 實作順序建議
   - **Step 1：先寫 `docs/ui-flow-editor-shell.md`**
     - 以「editor 外殼與模式切換」為第一個 feature，提供全局 UI 背景。
   - **Step 2：再拆 `toolbar` 與 `preview/split`**
     - 讓這兩個檔案只專注在各自的行為與設定，不重複 editor shell 的內容。
   - **Step 3：視實際需求才為 GPT、mobile 等新增 ui-flow 檔**
     - 避免檔案過多，符合 ELF 的「少量且穩定頂層文件」原則。

### [實作重點摘要]

- 本次完成：
  - 新增 `docs/todo/todo2025-11-22-02.md`，作為「UI flow 文件規劃」專用的 todo。
  - 梳理 `ui-flow-\<feature\>.md` 的定位與層級，區分與 `PROJECT_OVERVIEW.md` / `FRONTEND_ARCH.md` 的關係。
  - 草擬第一輪 UI feature 清單（editor-shell / toolbar / preview-split / settings / GPT 等）。
  - 定義每一份 `ui-flow-\<feature\>.md` 的預期結構與實作順序。
  - 依規劃陸續建立 UI flow 文件：
    - `docs/ui-flow-editor-shell.md`：描述 Editor Shell 的 UI 流程與關鍵檔案。
    - `docs/ui-flow-toolbar.md`：描述 toolbar preset / toolbarConfig / hiddenActionsConfig 與實際 UI 行為。
    - `docs/ui-flow-preview-split.md`：描述 preview / split mode 與快捷鍵的 UI 流程與資料流。
    - `docs/ui-flow-settings-panel.md`：描述 EditorSettings 如何控制模式、preview、split 與 toolbar visibility。
  - 建立 `README_ZH.md` 並翻譯 root `README.md` 內容，作為未來多國語言文件的起點。
  - 在 `README_ZH.md` 中補充「修改原始碼 vs `npm install` 套件」的差異說明，幫助之後的貢獻者理解開發與使用角色。
  - 在本機安裝專案依賴並執行 `npm start`，啟動跑在 `http://localhost:8888` 的 Storybook/demo。
  - 修正 `demo/stories/css-variables/CSSVariables.stories.tsx` 中 CSS Variables story 的語法錯誤（為 `--g-md-toolbar-padding` key 加上引號），讓 Storybook 可以成功 build。
  - 透過 Storybook 實際操作編輯器範例，確認基本編輯、toolbar 操作、preview/split 行為與文件描述一致，但 UI 視覺仍偏開發工具風格。

### [驗證與結果]

- 目前狀態已從純規劃，進展到「已啟動 Storybook 並完成首次試用」：
  - 已在本機執行 `npm start`，Storybook 能在 `http://localhost:8888` 正常載入各個 editor 範例。
  - 初次啟動時因 CSS Variables story 語法錯誤導致 Babel/TypeScript 解析失敗，已透過微調 key 寫法修正，之後重新編譯無錯誤。
  - 手動驗證 editor 主要互動（打字、toolbar 基本操作、preview/split 模式切換）行為合理，與 UI flow 文件與 README 敘述相符。
  - 目前尚未執行 `npm test` 或 `npm run build`，也尚未變更 editor 核心邏輯，僅針對 Storybook story 做極小幅語法修正。
